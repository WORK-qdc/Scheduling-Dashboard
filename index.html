<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Conference Scheduling Platform</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    :root {
      --primary: #5E72E4;
      --primary-dark: #4C63D2;
      --secondary: #F7FAFC;
      --success: #2DCE89;
      --info: #11CDEF;
      --warning: #FB6340;
      --danger: #F5365C;
      --dark: #212529;
      --light: #F8F9FE;
      --white: #FFFFFF;
      --gray-100: #F7FAFC;
      --gray-200: #E9ECEF;
      --gray-300: #DEE2E6;
      --gray-400: #CED4DA;
      --gray-500: #ADB5BD;
      --gray-600: #8898AA;
      --gray-700: #525F7F;
      --gray-800: #32325D;
      --gradient: linear-gradient(87deg, #5E72E4 0, #825EE4 100%);
      --shadow-soft: 0 4px 6px rgba(50, 50, 93, .11), 0 1px 3px rgba(0, 0, 0, .08);
      --shadow-hover: 0 7px 14px rgba(50, 50, 93, .1), 0 3px 6px rgba(0, 0, 0, .08);
      --shadow-lg: 0 15px 35px rgba(50, 50, 93, .1), 0 5px 15px rgba(0, 0, 0, .07);
    }

    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      background-color: var(--gray-100);
      color: var(--gray-800);
      line-height: 1.6;
    }

    /* Header Styles */
    .main-header {
      background: var(--gradient);
      color: white;
      padding: 2rem 0;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-soft);
    }

    .main-header h1 {
      font-weight: 700;
      font-size: 2rem;
      margin: 0;
      letter-spacing: -0.5px;
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 0.5rem 1.5rem;
      border-radius: 50px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      color: white;
      transform: translateY(-2px);
    }

    /* Card Styles */
    .main-card {
      background: white;
      border-radius: 15px;
      box-shadow: var(--shadow-soft);
      padding: 0;
      margin-bottom: 2rem;
      overflow: hidden;
      border: none;
    }

    /* View Toggle */
    .view-toggle {
      background: var(--gray-100);
      padding: 0.5rem;
      border-radius: 50px;
      display: inline-flex;
      gap: 0.5rem;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .view-btn {
      background: transparent;
      border: none;
      color: var(--gray-600);
      padding: 0.75rem 2rem;
      border-radius: 50px;
      font-weight: 500;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .view-btn:hover {
      color: var(--gray-800);
    }

    .view-btn.active {
      background: white;
      color: var(--primary);
      box-shadow: var(--shadow-soft);
    }

    /* Filter Bar */
    .filter-bar {
      background: var(--gray-100);
      padding: 1.5rem;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: white;
      padding: 0.5rem 1rem;
      border-radius: 10px;
      box-shadow: var(--shadow-soft);
    }

    .filter-group label {
      font-weight: 600;
      color: var(--gray-700);
      margin: 0;
      font-size: 0.875rem;
    }

    .filter-group .form-select,
    .filter-group .form-control {
      border: none;
      background: transparent;
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
      min-width: 150px;
    }

    /* Modern Table */
    .modern-table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
    }

    .modern-table thead {
      background: var(--gray-100);
    }

    .modern-table thead th {
      font-weight: 600;
      color: var(--gray-700);
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.5px;
      padding: 1rem;
      border-bottom: 2px solid var(--gray-200);
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--gray-100);
    }

    .modern-table tbody tr {
      transition: all 0.2s ease;
      border-bottom: 1px solid var(--gray-100);
    }

    .modern-table tbody tr:hover {
      background: var(--gray-50);
      transform: scale(1.01);
      box-shadow: var(--shadow-soft);
    }

    .modern-table tbody td {
      padding: 1rem;
      vertical-align: middle;
      font-size: 0.875rem;
      color: var(--gray-700);
    }

    /* Status Badges */
    .status-badge {
      padding: 0.35rem 0.85rem;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-block;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-confirmed {
      background: #D1F4E0;
      color: #0F5132;
    }

    .status-pending {
      background: #FFF3CD;
      color: #664D03;
    }

    .status-cancelled {
      background: #F8D7DA;
      color: #842029;
    }

    .status-completed {
      background: #D1ECF1;
      color: #0C5460;
    }

    /* Type Pills */
    .type-pill {
      padding: 0.25rem 0.75rem;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 500;
      display: inline-block;
    }

    .type-internal {
      background: var(--primary);
      color: white;
    }

    .type-external {
      background: var(--info);
      color: white;
    }

    /* Action Buttons */
    .action-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin: 0 0.25rem;
      transition: all 0.2s ease;
      cursor: pointer;
      font-size: 1rem;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .btn-edit {
      background: #E3F2FD;
      color: #1976D2;
    }

    .btn-edit:hover {
      background: #1976D2;
      color: white;
    }

    .btn-delete {
      background: #FFEBEE;
      color: #D32F2F;
    }

    .btn-delete:hover {
      background: #D32F2F;
      color: white;
    }

    .btn-save {
      background: #E8F5E9;
      color: #388E3C;
    }

    .btn-save:hover {
      background: #388E3C;
      color: white;
    }

    .btn-cancel {
      background: #F5F5F5;
      color: #616161;
    }

    .btn-cancel:hover {
      background: #616161;
      color: white;
    }

    /* Add Row Styles */
    .add-row {
      background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
    }

    .add-row td {
      padding: 1rem 0.5rem;
      border: none;
    }

    .add-row .form-control,
    .add-row .form-select {
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }

    .add-row .form-control:focus,
    .add-row .form-select:focus {
      border-color: white;
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
    }

    .btn-add-new {
      background: white;
      color: var(--primary);
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 50px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-soft);
    }

    .btn-add-new:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
      background: white;
      color: var(--primary-dark);
    }

    /* Calendar Styles */
    .calendar-wrapper {
      padding: 2rem;
      background: white;
      border-radius: 15px;
    }

    .fc {
      font-family: 'Inter', sans-serif;
    }

    .fc-toolbar-title {
      font-weight: 700;
      color: var(--gray-800);
    }

    .fc-button-primary {
      background: var(--primary);
      border: none;
      font-weight: 500;
      padding: 0.5rem 1rem;
      transition: all 0.2s ease;
    }

    .fc-button-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .fc-button-primary:not(:disabled).fc-button-active {
      background: var(--primary-dark);
    }

    .fc-event {
      background: var(--primary);
      border: none;
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .fc-event:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    /* Modal Styles */
    .modal-content {
      border: none;
      border-radius: 15px;
      overflow: hidden;
    }

    .modal-header {
      background: var(--gradient);
      color: white;
      border: none;
      padding: 1.5rem 2rem;
    }

    .modal-header h5 {
      font-weight: 600;
      margin: 0;
    }

    .modal-header .btn-close {
      filter: brightness(0) invert(1);
      opacity: 0.8;
    }

    /* Employee Management Button */
    .btn-manage {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.375rem 1rem;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 500;
      transition: all 0.2s ease;
      margin-left: 0.5rem;
    }

    .btn-manage:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    /* Editing Row */
    .editing-row {
      background: #FFF9E6 !important;
      box-shadow: inset 0 0 0 2px #FFD700;
    }

    .editing-row td {
      padding: 0.5rem;
    }

    /* Scrollbar */
    .table-container {
      max-height: calc(100vh - 300px);
      overflow-y: auto;
      overflow-x: auto;
    }

    .table-container::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    .table-container::-webkit-scrollbar-track {
      background: var(--gray-100);
      border-radius: 10px;
    }

    .table-container::-webkit-scrollbar-thumb {
      background: var(--gray-400);
      border-radius: 10px;
    }

    .table-container::-webkit-scrollbar-thumb:hover {
      background: var(--gray-500);
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .filter-bar {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filter-group {
        width: 100%;
        justify-content: space-between;
      }
    }

    /* Loading Animation */
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.3s ease;
      z-index: 9999;
    }

    .loading.active {
      transform: scaleX(1);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--gray-600);
    }

    .empty-state i {
      font-size: 4rem;
      color: var(--gray-400);
      margin-bottom: 1rem;
    }

    /* Tooltips */
    .tooltip-custom {
      background: var(--gray-800);
      color: white;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      font-size: 0.75rem;
      box-shadow: var(--shadow-lg);
    }
  </style>
</head>
<body>
  <!-- Loading Bar -->
  <div class="loading" id="loading-bar"></div>

  <!-- Header -->
  <div class="main-header">
    <div class="container-fluid px-4">
      <div class="d-flex justify-content-between align-items-center">
        <h1><i class="bi bi-calendar-event me-3"></i>Conference Scheduling Platform</h1>
        <a href="/Scheduling-Dashboard/logout.html" class="btn logout-btn">
          <i class="bi bi-box-arrow-right me-2"></i>Logout
        </a>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container-fluid px-4">
    <!-- View Toggle -->
    <div class="text-center mb-4">
      <div class="view-toggle">
        <button class="view-btn active" id="list-view-btn">
          <i class="bi bi-list-ul me-2"></i>List View
        </button>
        <button class="view-btn" id="calendar-view-btn">
          <i class="bi bi-calendar3 me-2"></i>Calendar View
        </button>
      </div>
    </div>

    <!-- List View -->
    <div id="list-container" class="main-card">
      <!-- Filter Bar -->
      <div class="filter-bar">
        <div class="filter-group">
          <label>Employee</label>
          <select id="employee-filter" class="form-select">
            <option value="">All Employees</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Month</label>
          <input id="start-date-filter" type="month" class="form-control" />
        </div>
        <div class="filter-group ms-auto">
          <button type="button" id="edit-employees-btn" class="btn-manage">
            <i class="bi bi-people me-2"></i>Manage Employees
          </button>
        </div>
      </div>

      <!-- Table -->
      <div class="table-container">
        <table class="modern-table">
          <thead>
            <tr>
              <th width="50">#</th>
              <th>Title</th>
              <th>Topic</th>
              <th>Status</th>
              <th>Start</th>
              <th>End</th>
              <th>Location</th>
              <th>Link</th>
              <th>Industry</th>
              <th>Description</th>
              <th>Deadline</th>
              <th>Type</th>
              <th>Speaker</th>
              <th>Notes</th>
              <th width="100">Actions</th>
            </tr>
          </thead>
          <tbody id="entries-tbody">
            <!-- Entries will be loaded here -->
          </tbody>
        </table>
      </div>

      <!-- Add New Row -->
      <table class="modern-table">
        <tbody>
          <tr class="add-row">
            <td width="50"></td>
            <td><input id="new-title" class="form-control" placeholder="Conference Title" /></td>
            <td><input id="new-topic" class="form-control" placeholder="Topic" /></td>
            <td>
              <select id="new-status" class="form-select">
                <option>Pending</option>
                <option>Confirmed</option>
                <option>Cancelled</option>
                <option>Completed</option>
              </select>
            </td>
            <td><input id="new-start" type="date" class="form-control" /></td>
            <td><input id="new-end" type="date" class="form-control" /></td>
            <td><input id="new-location" class="form-control" placeholder="Location" /></td>
            <td><input id="new-link" type="url" class="form-control" placeholder="https://..." /></td>
            <td><input id="new-industry" class="form-control" placeholder="Industry" /></td>
            <td><textarea id="new-desc" class="form-control" rows="1" placeholder="Description"></textarea></td>
            <td><input id="new-applicationdeadline" type="date" class="form-control" /></td>
            <td>
              <select id="new-type" class="form-select">
                <option>Internal</option>
                <option>External</option>
              </select>
            </td>
            <td>
              <select id="new-AssignedEmployee" class="form-select">
                <option value="">Select Speaker</option>
              </select>
            </td>
            <td><textarea id="new-notes" class="form-control" rows="1" placeholder="Notes"></textarea></td>
            <td class="text-center">
              <button type="button" id="add-entry-btn" class="btn-add-new">
                <i class="bi bi-plus-circle me-2"></i>Add
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Calendar View -->
    <div id="calendar-container" class="main-card" style="display: none;">
      <div class="filter-bar">
        <div class="filter-group">
          <label>Employee</label>
          <select id="calendar-employee-filter" class="form-select">
            <option value="">All Employees</option>
          </select>
        </div>
        <div class="filter-group ms-auto">
          <button type="button" id="calendar-list-view-btn" class="btn-manage">
            <i class="bi bi-arrow-left me-2"></i>Back to List
          </button>
        </div>
      </div>
      <div class="calendar-wrapper">
        <div id="calendar-table-wrapper"></div>
      </div>
    </div>
  </div>

  <!-- Employees Modal -->
  <div class="modal fade" id="employeeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-people me-2"></i>Employee Management
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <button type="button" id="add-emp-btn" class="btn-add-new mb-3">
            <i class="bi bi-person-plus me-2"></i>Add Employee
          </button>
          <table class="modern-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th width="100">Actions</th>
              </tr>
            </thead>
            <tbody id="employee-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://alcdn.msauth.net/browser/2.27.0/js/msal-browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@microsoft/microsoft-graph-client/lib/graph-js-sdk-web.js"></script>

  <script>
    // Loading indicator
    function showLoading() {
      document.getElementById('loading-bar').classList.add('active');
    }

    function hideLoading() {
      setTimeout(() => {
        document.getElementById('loading-bar').classList.remove('active');
      }, 300);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const msalConfig = {
        auth: {
          clientId: '8e23d112-104b-4e6a-a57d-7e3a2a61d837',
          authority: 'https://login.microsoftonline.com/20e27700-b670-4553-a27c-d8e2583b3289',
          redirectUri: 'https://work-qdc.github.io/Scheduling-Dashboard/'
        },
        cache: { cacheLocation: 'localStorage' }
      };

      const msalInstance = new msal.PublicClientApplication(msalConfig);

      async function signIn() {
        const accounts = msalInstance.getAllAccounts();
        if (!accounts.length) {
          await msalInstance.loginPopup({ scopes: ['User.Read', 'Sites.Read.All', 'Sites.ReadWrite.All'] });
        }
      }

      async function getToken(scopes) {
        try {
          return (await msalInstance.acquireTokenSilent({ scopes })).accessToken;
        } catch {
          return (await msalInstance.acquireTokenPopup({ scopes })).accessToken;
        }
      }

      function client(token) {
        return MicrosoftGraph.Client.init({ authProvider: done => done(null, token) });
      }

      let EMP_LIST_ID, SCHED_LIST_ID;

      async function getSiteId(g) {
        const site = await g.api(`/sites/tcco.sharepoint.com:/sites/SchedulingToolTest:/`).get();
        return site.id;
      }

      async function initLists() {
        showLoading();
        await signIn();
        const token = await getToken(['Sites.Read.All']);
        const g = client(token);
        const sid = await getSiteId(g);
        const res = await g.api(`/sites/${sid}/lists`).get();
        EMP_LIST_ID = res.value.find(l => l.displayName === 'SchedulingEmployeeTest').id;
        SCHED_LIST_ID = res.value.find(l => l.displayName === 'TestTableScheduling').id;
        hideLoading();
      }

      async function fetchEmployees() {
        showLoading();
        const token = await getToken(['Sites.Read.All']);
        const g = client(token);
        const sid = await getSiteId(g);
        const r = await g.api(`/sites/${sid}/lists/${EMP_LIST_ID}/items`).expand('fields').get();
        window.employees = r.value.map(i => ({ id: i.id, name: i.fields.Title, email: i.fields.Employeesemail }));
        populateEmployeeSelects();
        renderEmployeeTable();
        hideLoading();
      }

      async function fetchEntries() {
        showLoading();
        const token = await getToken(['Sites.Read.All']);
        const g = client(token);
        const sid = await getSiteId(g);
        const r = await g.api(`/sites/${sid}/lists/${SCHED_LIST_ID}/items`).expand('fields').get();
        window.entries = r.value.map(i => ({
          id: i.id, 
          title: i.fields.Title || '', 
          topic: i.fields.Topic || '', 
          status: i.fields.RegistrationStatus || '',
          start: i.fields.StartDate || '', 
          end: i.fields.EndDate || '', 
          location: i.fields.Location || '',
          link: i.fields.Link || '', 
          industry: i.fields.Industry || '', 
          desc: i.fields.Description || '',
          applicationdeadline: i.fields.ApplicationDeadline || '', 
          internalExternal: i.fields.Internal_x002f_External || '', 
          AssignedEmployee: i.fields.AssignedEmployee || '',
          notes: i.fields.Notes || ''
        }));
        renderList();
        hideLoading();
      }

      async function addEmployee() {
        const name = prompt('Enter employee name:');
        const email = prompt('Enter employee email:');
        if (!name || !email) return;
        showLoading();
        const token = await getToken(['Sites.ReadWrite.All']);
        const g = client(token);
        const sid = await getSiteId(g);
        await g.api(`/sites/${sid}/lists/${EMP_LIST_ID}/items`).post({ fields: { Title: name, Employeesemail: email } });
        await fetchEmployees();
      }

      async function addEntry() {
        try {
          showLoading();
          const token = await getToken(['Sites.ReadWrite.All']);
          const g = client(token);
          const sid = await getSiteId(g);

          const sel = document.getElementById('new-AssignedEmployee');
          const selectedOption = sel.options[sel.selectedIndex];
          const assignedEmployeeName = selectedOption.value;
          const assignedEmployeeEmail = (window.employees.find(e => e.name === assignedEmployeeName) || {}).email;

          const fields = {
            Title: document.getElementById('new-title').value,
            Topic: document.getElementById('new-topic').value,
            RegistrationStatus: document.getElementById('new-status').value,
            TypeofEngagement: document.getElementById('new-type').value,
            StartDate: document.getElementById('new-start').value,
            EndDate: document.getElementById('new-end').value,
            Location: document.getElementById('new-location').value,
            Link: document.getElementById('new-link').value,
            Industry: document.getElementById('new-industry').value,
            Description: document.getElementById('new-desc').value,
            ApplicationDeadline: document.getElementById('new-applicationdeadline').value,
            Internal_x002f_External: document.getElementById('new-type').value,
            AssignedEmployee: assignedEmployeeName,
            Notes: document.getElementById('new-notes').value
          };

          await g.api(`/sites/${sid}/lists/${SCHED_LIST_ID}/items`).post({ fields });

          // Send calendar invite
          if (assignedEmployeeEmail && assignedEmployeeEmail.includes('@')) {
            const event = {
              subject: fields.Title || 'Scheduled Event',
              body: {
                contentType: 'Text',
                content: fields.Description || 'Scheduled event via scheduling tool.'
              },
              start: {
                dateTime: `${fields.StartDate}T09:00:00`,
                timeZone: 'UTC'
              },
              end: {
                dateTime: `${fields.EndDate}T17:00:00`,
                timeZone: 'UTC'
              },
              location: {
                displayName: fields.Location || 'TBD'
              },
              attendees: [
                {
                  emailAddress: {
                    address: assignedEmployeeEmail,
                    name: assignedEmployeeName
                  },
                  type: 'required'
                }
              ],
              responseRequested: true,
              isOnlineMeeting: false
            };

            try {
              await g.api('/me/events')
                .query({ sendInvitations: true })
                .post(event);
              console.log('✅ Calendar invite sent to:', assignedEmployeeEmail);
            } catch (inviteErr) {
              console.error('❌ Failed to send calendar invite:', inviteErr);
              alert(`Event created, but failed to send invite:\n${inviteErr.message}`);
            }
          }

          await fetchEntries();
          clearAddForm();
        } catch (err) {
          console.error('addEntry failed:', err);
          alert(`Error adding entry:\n${err.message}`);
        } finally {
          hideLoading();
        }
      }

      function clearAddForm() {
        document.getElementById('new-title').value = '';
        document.getElementById('new-topic').value = '';
        document.getElementById('new-status').value = 'Pending';
        document.getElementById('new-start').value = '';
        document.getElementById('new-end').value = '';
        document.getElementById('new-location').value = '';
        document.getElementById('new-link').value = '';
        document.getElementById('new-industry').value = '';
        document.getElementById('new-desc').value = '';
        document.getElementById('new-applicationdeadline').value = '';
        document.getElementById('new-AssignedEmployee').value = '';
        document.getElementById('new-notes').value = '';
      }

      function populateEmployeeSelects() {
        const sel = document.getElementById('new-AssignedEmployee');
        const filterSel = document.getElementById('employee-filter');
        const calSel = document.getElementById('calendar-employee-filter');

        sel.innerHTML = '<option value="">Select Speaker</option>';
        filterSel.innerHTML = '<option value="">All Employees</option>';
        calSel.innerHTML = '<option value="">All Employees</option>';

        window.employees.forEach(e => {
          const o1 = document.createElement('option');
          o1.value = e.name;
          o1.textContent = e.name;
          sel.appendChild(o1);

          const o2 = o1.cloneNode(true);
          filterSel.appendChild(o2);

          const o3 = o1.cloneNode(true);
          calSel.appendChild(o3);
        });
      }

      function renderEmployeeTable() {
        const body = document.getElementById('employee-table-body');
        body.innerHTML = '';
        window.employees.forEach(e => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${e.name}</td>
            <td>${e.email}</td>
            <td class="text-center">
              <button class="action-btn btn-delete" data-id="${e.id}">
                <i class="bi bi-trash"></i>
              </button>
            </td>`;
          tr.querySelector('button').addEventListener('click', async () => {
            if (confirm(`Delete employee ${e.name}?`)) {
              showLoading();
              const token = await getToken(['Sites.ReadWrite.All']);
              const g = client(token);
              const sid = await getSiteId(g);
              await g.api(`/sites/${sid}/lists/${EMP_LIST_ID}/items/${e.id}`).delete();
              await fetchEmployees();
            }
          });
          body.appendChild(tr);
        });
      }

      function getStatusBadge(status) {
        const statusClass = {
          'Confirmed': 'status-confirmed',
          'Pending': 'status-pending',
          'Cancelled': 'status-cancelled',
          'Completed': 'status-completed'
        }[status] || 'status-pending';
        
        return `<span class="status-badge ${statusClass}">${status || 'Pending'}</span>`;
      }

      function getTypePill(type) {
        const typeClass = type === 'Internal' ? 'type-internal' : 'type-external';
        return `<span class="type-pill ${typeClass}">${type || 'Internal'}</span>`;
      }

      function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }

      function formatDateOnly(isoString) {
        if (!isoString || typeof isoString !== 'string') return '';
        return isoString.split('T')[0];
      }

      function truncate(str, len) {
        if (!str) return '';
        return str.length > len ? str.substring(0, len) + '...' : str;
      }

      function renderCalendarView() {
        const container = document.getElementById('calendar-table-wrapper');
        container.innerHTML = '';

        const calendarEl = document.createElement('div');
        container.appendChild(calendarEl);

        const selectedEmployee = document.getElementById('calendar-employee-filter').value;

        const filteredEvents = window.entries
          .filter(e => !selectedEmployee || e.AssignedEmployee === selectedEmployee)
          .map(e => ({
            id: e.id,
            title: e.title || '(No Title)',
            start: e.start,
            end: e.end,
            backgroundColor: e.status === 'Confirmed' ? '#2DCE89' : 
                           e.status === 'Cancelled' ? '#F5365C' : 
                           e.status === 'Completed' ? '#11CDEF' : '#FB6340',
            extendedProps: {
              location: e.location,
              notes: e.notes,
              status: e.status,
              topic: e.topic
            }
          }));

        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          height: 'auto',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek'
          },
          events: filteredEvents,
          eventClick: function(info) {
            const { title, start, end, extendedProps } = info.event;
            const modal = new bootstrap.Modal(document.getElementById('eventModal') || createEventModal());
            document.getElementById('eventModalBody').innerHTML = `
              <p><strong>Title:</strong> ${title}</p>
              <p><strong>Topic:</strong> ${extendedProps.topic || 'N/A'}</p>
              <p><strong>Status:</strong> ${getStatusBadge(extendedProps.status)}</p>
              <p><strong>Start:</strong> ${formatDate(start)}</p>
              <p><strong>End:</strong> ${formatDate(end)}</p>
              <p><strong>Location:</strong> ${extendedProps.location || 'N/A'}</p>
              <p><strong>Notes:</strong> ${extendedProps.notes || 'None'}</p>
            `;
            modal.show();
          }
        });

        calendar.render();
      }

      function createEventModal() {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'eventModal';
        modal.innerHTML = `
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" id="eventModalBody"></div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        return modal;
      }

      function renderList() {
        const tbody = document.getElementById('entries-tbody');
        tbody.innerHTML = '';
        
        if (window.entries.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="15" class="empty-state">
                <i class="bi bi-calendar-x"></i>
                <p>No conferences scheduled yet. Add your first conference using the form below!</p>
              </td>
            </tr>
          `;
          return;
        }
        
        window.entries.forEach((e, idx) => {
          const tr = document.createElement('tr');

          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td><strong>${e.title}</strong></td>
            <td>${e.topic}</td>
            <td>${getStatusBadge(e.status)}</td>
            <td>${formatDate(e.start)}</td>
            <td>${formatDate(e.end)}</td>
            <td>${e.location}</td>
            <td>${e.link ? `<a href="${e.link}" target="_blank"><i class="bi bi-link-45deg"></i></a>` : ''}</td>
            <td>${e.industry}</td>
            <td><small>${truncate(e.desc, 50)}</small></td>
            <td>${formatDate(e.applicationdeadline)}</td>
            <td>${getTypePill(e.internalExternal)}</td>
            <td>${e.AssignedEmployee || '<em>Unassigned</em>'}</td>
            <td><small>${truncate(e.notes, 50)}</small></td>
            <td class="text-center">
              <button class="action-btn btn-edit edit-entry" data-id="${e.id}" title="Edit">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="action-btn btn-delete del-entry" data-id="${e.id}" title="Delete">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          `;

          // Delete logic
          tr.querySelector('.del-entry').addEventListener('click', async () => {
            if (confirm(`Delete "${e.title}"?`)) {
              showLoading();
              const token = await getToken(['Sites.ReadWrite.All']);
              const g = client(token);
              const sid = await getSiteId(g);
              await g.api(`/sites/${sid}/lists/${SCHED_LIST_ID}/items/${e.id}`).delete();
              await fetchEntries();
            }
          });

          // Edit logic
          tr.querySelector('.edit-entry').addEventListener('click', () => {
            enableEditMode(tr, e);
          });

          tbody.appendChild(tr);
        });
        applyFilters();
      }

      function applyFilters() {
        const selected = document.getElementById('employee-filter').value;
        const month = document.getElementById('start-date-filter').value;
        const rows = document.querySelectorAll('#entries-tbody tr');
        
        rows.forEach((row, index) => {
          const entry = window.entries[index];
          if (!entry) return;
          
          let show = true;
          
          if (selected && entry.AssignedEmployee !== selected) show = false;
          
          if (month && entry.start) {
            const entryMonth = entry.start.substring(0, 7);
            if (entryMonth !== month) show = false;
          }
          
          row.style.display = show ? '' : 'none';
        });
      }

      function enableEditMode(row, entry) {
        row.classList.add('editing-row');
        const td = row.querySelectorAll('td');
        
        td[1].innerHTML = `<input class="form-control form-control-sm" value="${entry.title}" />`;
        td[2].innerHTML = `<input class="form-control form-control-sm" value="${entry.topic}" />`;
        td[3].innerHTML = `<select class="form-select form-select-sm">
          <option ${entry.status === 'Pending' ? 'selected' : ''}>Pending</option>
          <option ${entry.status === 'Confirmed' ? 'selected' : ''}>Confirmed</option>
          <option ${entry.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
          <option ${entry.status === 'Completed' ? 'selected' : ''}>Completed</option>
        </select>`;
        td[4].innerHTML = `<input type="date" class="form-control form-control-sm" value="${formatDateOnly(entry.start)}" />`;
        td[5].innerHTML = `<input type="date" class="form-control form-control-sm" value="${formatDateOnly(entry.end)}" />`;
        td[6].innerHTML = `<input class="form-control form-control-sm" value="${entry.location}" />`;
        td[7].innerHTML = `<input class="form-control form-control-sm" value="${entry.link}" />`;
        td[8].innerHTML = `<input class="form-control form-control-sm" value="${entry.industry}" />`;
        td[9].innerHTML = `<textarea class="form-control form-control-sm" rows="2">${entry.desc}</textarea>`;
        td[10].innerHTML = `<input type="date" class="form-control form-control-sm" value="${formatDateOnly(entry.applicationdeadline)}" />`;
        td[11].innerHTML = `<select class="form-select form-select-sm">
          <option ${entry.internalExternal === 'Internal' ? 'selected' : ''}>Internal</option>
          <option ${entry.internalExternal === 'External' ? 'selected' : ''}>External</option>
        </select>`;
        td[12].innerHTML = `<select class="form-select form-select-sm">
          <option value="">Unassigned</option>
          ${window.employees.map(e => 
            `<option value="${e.name}" ${e.name === entry.AssignedEmployee ? 'selected' : ''}>
              ${e.name}
            </option>`
          ).join('')}
        </select>`;
        td[13].innerHTML = `<textarea class="form-control form-control-sm" rows="2">${entry.notes}</textarea>`;
        td[14].innerHTML = `
          <button class="action-btn btn-save save-edit" title="Save">
            <i class="bi bi-check-lg"></i>
          </button>
          <button class="action-btn btn-cancel cancel-edit" title="Cancel">
            <i class="bi bi-x-lg"></i>
          </button>`;

        td[14].querySelector('.save-edit').addEventListener('click', async () => {
          showLoading();
          const updated = {};
          const set = (key, val) => {
            if (val !== '') updated[key] = val;
          };

          set('Title', td[1].querySelector('input').value);
          set('Topic', td[2].querySelector('input').value);
          set('RegistrationStatus', td[3].querySelector('select').value);
          set('StartDate', td[4].querySelector('input').value);
          set('EndDate', td[5].querySelector('input').value);
          set('Location', td[6].querySelector('input').value);
          set('Link', td[7].querySelector('input').value);
          set('Industry', td[8].querySelector('input').value);
          set('Description', td[9].querySelector('textarea').value);
          set('ApplicationDeadline', td[10].querySelector('input').value);
          set('Internal_x002f_External', td[11].querySelector('select').value);
          set('AssignedEmployee', td[12].querySelector('select').value);
          set('Notes', td[13].querySelector('textarea').value);

          try {
            const token = await getToken(['Sites.ReadWrite.All']);
            const g = client(token);
            const sid = await getSiteId(g);

            await g.api(`/sites/${sid}/lists/${SCHED_LIST_ID}/items/${entry.id}/fields`)
              .patch(updated);

            // Send calendar invite when an employee is assigned
            const assignedName = td[12].querySelector('select').value;
            const assignedEmail = (window.employees.find(e => e.name === assignedName) || {}).email;

            if (assignedEmail && assignedEmail.includes('@')) {
              const event = {
                subject: updated.Title || 'Scheduled Event',
                body: {
                  contentType: 'Text',
                  content: updated.Description || 'Scheduled event via scheduling tool.'
                },
                start: {
                  dateTime: `${updated.StartDate || entry.start}T09:00:00`,
                  timeZone: 'UTC'
                },
                end: {
                  dateTime: `${updated.EndDate || entry.end}T17:00:00`,
                  timeZone: 'UTC'
                },
                location: {
                  displayName: updated.Location || 'TBD'
                },
                attendees: [
                  {
                    emailAddress: {
                      address: assignedEmail,
                      name: assignedName
                    },
                    type: 'required'
                  }
                ],
                responseRequested: true,
                isOnlineMeeting: false
              };

              try {
                await g.api('/me/events')
                  .query({ sendInvitations: true })
                  .post(event);
                console.log('✅ Calendar invite sent to:', assignedEmail);
              } catch (inviteErr) {
                console.error('❌ Failed to send calendar invite:', inviteErr);
              }
            }

            await fetchEntries();
          } catch (err) {
            console.error('editEntry failed:', err);
            alert(`Failed to save edits:\n${err.message}`);
            hideLoading();
          }
        });

        td[14].querySelector('.cancel-edit').addEventListener('click', () => {
          renderList();
        });
      }

      // View switching
      document.getElementById('calendar-view-btn').addEventListener('click', () => {
        document.getElementById('list-view-btn').classList.remove('active');
        document.getElementById('calendar-view-btn').classList.add('active');
        document.getElementById('calendar-container').style.display = 'block';
        document.getElementById('list-container').style.display = 'none';
        renderCalendarView();
      });

      document.getElementById('list-view-btn').addEventListener('click', () => {
        document.getElementById('calendar-view-btn').classList.remove('active');
        document.getElementById('list-view-btn').classList.add('active');
        document.getElementById('calendar-container').style.display = 'none';
        document.getElementById('list-container').style.display = 'block';
      });

      document.getElementById('calendar-list-view-btn').addEventListener('click', () => {
        document.getElementById('list-view-btn').click();
      });

      // Modal and button handlers
      document.getElementById('edit-employees-btn').addEventListener('click', () =>
        new bootstrap.Modal(document.getElementById('employeeModal')).show()
      );
      document.getElementById('add-emp-btn').addEventListener('click', addEmployee);
      document.getElementById('add-entry-btn').addEventListener('click', addEntry);

      // Filter handlers
      document.getElementById('employee-filter').addEventListener('change', applyFilters);
      document.getElementById('start-date-filter').addEventListener('change', applyFilters);
      document.getElementById('calendar-employee-filter').addEventListener('change', renderCalendarView);

      // Initialize
      try {
        await initLists();
        await fetchEmployees();
        await fetchEntries();
      } catch (err) {
        console.error('Initialization error:', err);
        alert(`Initialization error:\n${err.message}`);
        hideLoading();
      }
    });
  </script>
</body>
</html>
