<body>
<div class="container my-5 position-relative">
<div class="d-flex justify-content-end mb-2">
      <button id="logout-btn" class="btn btn-danger btn-sm">Logout</button>
      <button type="button" id="logout-btn" class="btn btn-danger btn-sm">Logout</button>
</div>
<h1 class="mb-4 text-center">Scheduling Tool</h1>

<!-- View Switch -->
<div id="view-switch" class="mb-3 text-center">
<div class="btn-group" role="group">
        <button id="calendar-view-btn" class="btn btn-primary">Calendar View</button>
        <button id="list-view-btn" class="btn btn-secondary d-none">List View</button>
        <button type="button" id="calendar-view-btn" class="btn btn-primary">Calendar View</button>
        <button type="button" id="list-view-btn" class="btn btn-secondary d-none">List View</button>
</div>
</div>

<!-- Calendar Panel -->
<div id="calendar-container" class="card shadow">
<div class="card-header d-flex justify-content-between align-items-center">
<h5 class="mb-0">Calendar</h5>
        <button id="calendar-list-view-btn" class="btn btn-outline-secondary btn-sm">← Back to List</button>
        <button type="button" id="calendar-list-view-btn" class="btn btn-outline-secondary btn-sm">← Back to List</button>
</div>
<div id="calendar-table-wrapper" class="card-body p-3 overflow-auto"></div>
</div>
@@ -56,7 +56,7 @@ <h5 class="mb-0">Calendar</h5>
<th>Deliverables</th>
<th>Type</th>
<th>Reco. Emp.</th>
            <th>Assigned Emp.<button id="edit-employees-btn" class="btn btn-sm btn-outline-secondary ms-2">Manage Employees</button></th>
            <th>Assigned Emp.<button type="button" id="edit-employees-btn" class="btn btn-sm btn-outline-secondary ms-2">Manage Employees</button></th>
<th>Notes</th>
<th>Actions</th>
</tr>
@@ -80,7 +80,7 @@ <h5 class="mb-0">Calendar</h5>
<td><input id="new-reco" class="form-control form-control-sm" placeholder="Employee"></td>
<td><select id="new-assigned" class="form-select form-select-sm"><option value="">--Select--</option></select></td>
<td><textarea id="new-notes" rows="1" class="form-control form-control-sm" placeholder="Notes"></textarea></td>
            <td><button id="add-entry-btn" class="btn btn-primary btn-sm">Add</button></td>
            <td><button type="button" id="add-entry-btn" class="btn btn-primary btn-sm">Add</button></td>
</tr>
</tfoot>
</table>
@@ -93,10 +93,10 @@ <h5 class="mb-0">Calendar</h5>
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Manage Employees</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
          <button id="add-emp-btn" class="btn btn-sm btn-primary mb-3">Add Employee</button>
          <button type="button" id="add-emp-btn" class="btn btn-sm btn-primary mb-3">Add Employee</button>
<table class="table table-bordered">
<thead><tr><th>Name</th><th>Email</th><th>Actions</th></tr></thead>
<tbody id="employee-table-body"></tbody>
@@ -130,21 +130,15 @@ <h5 class="modal-title">Manage Employees</h5>
msalInstance.logoutRedirect({ postLogoutRedirectUri: window.location.origin + window.location.pathname + 'logout.html' });

async function signIn() {
      if (!msalInstance.getAllAccounts().length) {
        await msalInstance.loginPopup({ scopes: ['User.Read','Calendars.ReadWrite','Sites.Read.All','Sites.ReadWrite.All'] });
      }
      if (!msalInstance.getAllAccounts().length) await msalInstance.loginPopup({ scopes: ['User.Read','Calendars.ReadWrite','Sites.Read.All','Sites.ReadWrite.All'] });
}
async function getToken(scopes) {
try { return (await msalInstance.acquireTokenSilent({ scopes })).accessToken; }
catch { return (await msalInstance.acquireTokenPopup({ scopes })).accessToken; }
}
    function client(token) {
      return MicrosoftGraph.Client.init({ authProvider: (done) => done(null, token) });
    }
    function client(token) { return MicrosoftGraph.Client.init({ authProvider: (done) => done(null, token) }); }

    async function getSiteId(c) {
      return (await c.api(`/sites/${HOST}:${PATH}:/`).get()).id;
    }
    async function getSiteId(c) { return (await c.api(`/sites/${HOST}:${PATH}:/`).get()).id; }

async function fetchEmployees() {
await signIn();
@@ -163,24 +157,7 @@ <h5 class="modal-title">Manage Employees</h5>
const c = client(t);
const sid = await getSiteId(c);
const r = await c.api(`/sites/${sid}/lists/${SCHED}/items`).expand('fields').get();
      window.entries = r.value.map(i => ({
        id: i.id,
        title: i.fields.Title,
        topic: i.fields.Topic,
        status: i.fields.Status,
        start: i.fields.Start,
        end: i.fields.End,
        location: i.fields.Location,
        link: i.fields.Link,
        industry: i.fields.Industry,
        desc: i.fields.Description,
        deadline: i.fields.Deadline,
        deliver: i.fields.Deliverables,
        type: i.fields.Type,
        reco: i.fields.RecoEmp,
        assigned: i.fields.AssignedEmp,
        notes: i.fields.Notes
      }));
      window.entries = r.value.map(i => ({ id: i.id, title: i.fields.Title, topic: i.fields.Topic, status: i.fields.Status, start: i.fields.Start, end: i.fields.End, location: i.fields.Location, link: i.fields.Link, industry: i.fields.Industry, desc: i.fields.Description, deadline: i.fields.Deadline, deliver: i.fields.Deliverables, type: i.fields.Type, reco: i.fields.RecoEmp, assigned: i.fields.AssignedEmp, notes: i.fields.Notes }));
renderList();
}

@@ -193,12 +170,7 @@ <h5 class="modal-title">Manage Employees</h5>
// Populate selects
function populateEmployeeSelects() {
newAssigned.innerHTML = '<option value="">--Select--</option>';
      employees.forEach(e => {
        const o = document.createElement('option');
        o.value = e.email;
        o.textContent = e.name;
        newAssigned.appendChild(o);
      });
      employees.forEach(e => { const o = document.createElement('option'); o.value = e.email; o.textContent = e.name; newAssigned.appendChild(o); });
}

// Render employees in modal
@@ -210,7 +182,7 @@ <h5 class="modal-title">Manage Employees</h5>
tr.innerHTML = `
<td>${e.name}</td>
<td>${e.email}</td>
          <td><button class="btn btn-sm btn-outline-danger" data-id="${e.id}" data-action="del-emp">Delete</button></td>
          <td><button type="button" class="btn btn-sm btn-outline-danger" data-id="${e.id}" data-action="del-emp">Delete</button></td>
`;
body.appendChild(tr);
});
@@ -224,7 +196,7 @@ <h5 class="modal-title">Manage Employees</h5>
const dn = emp.name || e.assigned;
const tr = document.createElement('tr');
tr.innerHTML = `
          <td><button class="btn btn-link p-0" data-idx="${idx}" data-action="menu">⋮</button></td>
          <td><button type="button" class="btn btn-link p-0" data-idx="${idx}" data-action="menu">⋮</button></td>
<td>${e.title}</td>
<td>${e.topic}</td>
<td>${e.status}</td>
@@ -241,133 +213,3 @@ <h5 class="modal-title">Manage Employees</h5>
<td>${dn}</td>
<td>${e.notes}</td>
<td></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Initialize Bootstrap modal instance
    const empModal = new bootstrap.Modal(document.getElementById('employeeModal'));

    // Manage Employees button
    document.getElementById('edit-employees-btn').onclick = () => empModal.show();

    // Add Employee
    document.getElementById('add-emp-btn').onclick = async () => {
      const name = prompt('Enter employee name:'); if (!name) return;
      const email = prompt('Enter employee email:'); if (!email) return;
      await signIn();
      const t = await getToken(['Sites.ReadWrite.All']);
      const c = client(t);
      const sid = await getSiteId(c);
      await c.api(`/sites/${sid}/lists/${EMP}/items`).post({ fields: { Title: name, Employeesemail: email } });
      await fetchEmployees();
    };

    // Add or Save Entry
    addBtn.onclick = async () => {
      const fields = {
        Title: document.getElementById('new-title').value,
        Topic: document.getElementById('new-topic').value,
        Status: document.getElementById('new-status').value,
        Start: document.getElementById('new-start').value,
        End: document.getElementById('new-end').value,
        Location: document.getElementById('new-location').value,
        Link: document.getElementById('new-link').value,
        Industry: document.getElementById('new-industry').value,
        Description: document.getElementById('new-desc').value,
        Deadline: document.getElementById('new-deadline').value,
        Deliverables: document.getElementById('new-deliver').value,
        Type: document.getElementById('new-type').value,
        RecoEmp: document.getElementById('new-reco').value,
        AssignedEmp: document.getElementById('new-assigned').value,
        Notes: document.getElementById('new-notes').value
      };
      await signIn();
      const t = await getToken(['Sites.ReadWrite.All']);
      const c = client(t);
      const sid = await getSiteId(c);
      if (editingIndex === null) {
        await c.api(`/sites/${sid}/lists/${SCHED}/items`).post({ fields });
      } else {
        const itemId = entries[editingIndex].id;
        await c.api(`/sites/${sid}/lists/${SCHED}/items/${itemId}`).patch({ fields });
        editingIndex = null;
        addBtn.textContent = 'Add';
      }
      await fetchEntries();
      // Clear inputs
      document.querySelectorAll('tfoot input, tfoot textarea, tfoot select').forEach(el => el.value = '');
    };

    // Row Actions (Edit/Delete)
    tbody.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const action = btn.dataset.action;
      const idx = btn.dataset.idx || btn.dataset.id;
      if (action === 'menu') {
        const choice = prompt('Type "edit" to edit or "delete" to remove this entry:');
        if (choice === 'edit') {
          editingIndex = idx;
          const e = entries[idx];
          ['title','topic','status','start','end','location','link','industry','desc','deadline','deliver','type','reco','assigned','notes'].forEach(field => {
            const el = document.getElementById(`new-${field}`);
            if (el) el.value = e[field];
          });
          addBtn.textContent = 'Save';
        } else if (choice === 'delete') {
          if (confirm('Are you sure you want to delete this entry?')) {
            await signIn();
            const t2 = await getToken(['Sites.ReadWrite.All']);
            const c2 = client(t2);
            const sid2 = await getSiteId(c2);
            await c2.api(`/sites/${sid2}/lists/${SCHED}/items/${entries[idx].id}`).delete();
            await fetchEntries();
          }
        }
      } else if (action === 'del-emp') {
        if (confirm('Remove this employee?')) {
          await signIn();
          const t3 = await getToken(['Sites.ReadWrite.All']);
          const c3 = client(t3);
          const sid3 = await getSiteId(c3);
          await c3.api(`/sites/${sid3}/lists/${EMP}/items/${idx}`).delete();
          await fetchEmployees();
        }
      }
    });

    // View toggles
    document.getElementById('calendar-view-btn').onclick = () => {
      renderCalendar();
      document.getElementById('list-container').style.display = 'none';
      document.getElementById('calendar-container').style.display = 'block';
    };
    document.getElementById('calendar-list-view-btn').onclick = () => {
      document.getElementById('calendar-container').style.display = 'none';
      document.getElementById('list-container').style.display = 'block';
    };

    // Calendar renderer
    function renderCalendar() {
      const d = new Date(), y = d.getFullYear(), m = d.getMonth();
      const f = new Date(y, m, 1).getDay();
      const days = new Date(y, m+1, 0).getDate();
      let html = '<table class="table table-bordered"><tr>' + ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(t=>`<th>${t}</th>`).join('') + '</tr><tr>';
      for (let i=0; i<f; i++) html += '<td></td>';
      for (let day=1; day<=days; day++) {
        const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const evs = entries.filter(e => e.start <= ds && ds <= e.end);
        html += `<td><strong>${day}</strong>${evs.map(ev => `<div>${ev.title}</div>`).join('')}</td>`;
        if ((day+f) %7==0 && day<days) html+='</tr><tr>';
      }
      html+='</tr></table>';
      document.getElementById('calendar-table-wrapper').innerHTML = html;
    }

    // Bootstrap modals & initial data load
    (async () => { await fetchEmployees(); await fetchEntries(); })();
  </script>
</body>
</html>
