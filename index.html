<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scheduling Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- FullCalendar CSS -->F
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />

<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <style>
    #calendar-container {
      display: none;
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      width: 90%;
      max-width: 800px;
      background: white;
    }
  </style>
</head>
<body>
  <div class="container my-5 position-relative">
    <div class="d-flex justify-content-end mb-2">
      <a href="/Scheduling-Dashboard/logout.html" class="btn btn-danger btn-sm">Logout</a>
    </div>
    <h1 class="mb-4 text-center">Scheduling Tool</h1>

    <div id="view-switch" class="mb-3 text-center">
      <div class="btn-group" role="group">
        <button type="button" id="calendar-view-btn" class="btn btn-primary">Calendar View</button>
        <button type="button" id="list-view-btn" class="btn btn-secondary d-none">List View</button>
      </div>
    </div>

    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
  <h5 class="mb-0">Calendar</h5>
  <div class="d-flex align-items-center">
    <label class="me-2 mb-0">Filter by Turner Speaker:</label>
    <select id="calendar-employee-filter" class="form-select form-select-sm">
      <option value="">All</option>
    </select>
  </div>
  <button type="button" id="calendar-list-view-btn" class="btn btn-outline-secondary btn-sm ms-auto">‚Üê Back to List</button>
</div>

      <div id="calendar-table-wrapper" class="card-body p-3 overflow-auto"></div>
    </div>

    <div id="list-container" class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th></th><th>Title</th><th>Topic</th><th>Status</th><th>Start</th><th>End</th>
            <th>Location</th><th>Link</th><th>Industry</th><th>Description</th><th>ApplicationDeadline</th>
            <th>Internal/External</th>
            <th>Turner Speaker <button type="button" id="edit-employees-btn" class="btn btn-sm btn-outline-secondary ms-2">Manage Employees</button></th>
            <th>Notes</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="entries-tbody"></tbody>
        <tfoot>
  <tr>
    <td></td>
    <td><input id="new-title" class="form-control form-control-sm" placeholder="Title" /></td>
    <td><input id="new-topic" class="form-control form-control-sm" placeholder="Topic" /></td>
    <td><input id="new-status" class="form-control form-control-sm" placeholder="Status" /></td>
    <td><input id="new-start" type="date" class="form-control form-control-sm" /></td>
    <td><input id="new-end" type="date" class="form-control form-control-sm" /></td>
    <td><input id="new-location" class="form-control form-control-sm" placeholder="Location" /></td>
    <td><input id="new-link" type="url" class="form-control form-control-sm" placeholder="http://‚Ä¶" /></td>
    <td><input id="new-industry" class="form-control form-control-sm" placeholder="Industry" /></td>
    <td><textarea id="new-desc" rows="1" class="form-control form-control-sm" placeholder="Description"></textarea></td>
    <td><input id="new-applicationdeadline" type="date" class="form-control form-control-sm" /></td>
    <td>
      <select id="new-type" class="form-select form-select-sm">
        <option>Internal</option>
        <option>External</option>
      </select>
    </td>
    <td>
      <!-- Turner Speaker dropdown for both adding and filtering -->
      <select id="new-AssignedEmployee" class="form-select form-select-sm mb-1">
        <option value="">--Select--</option>
      </select>
      <select id="employee-filter" class="form-select form-select-sm">
        <option value="">All</option>
      </select>
    </td>
    <td><textarea id="new-notes" rows="1" class="form-control form-control-sm" placeholder="Notes"></textarea></td>
    <td><button type="button" id="add-entry-btn" class="btn btn-primary btn-sm">Add</button></td>
  </tr>
</tfoot>
      </table>
    </div>
  </div>

  <!-- Employees Modal -->
  <div class="modal fade" id="employeeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Manage Employees</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <button type="button" id="add-emp-btn" class="btn btn-sm btn-primary mb-3">Add Employee</button>
          <table class="table table-bordered">
            <thead><tr><th>Name</th><th>Email</th><th>Actions</th></tr></thead>
            <tbody id="employee-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://alcdn.msauth.net/browser/2.27.0/js/msal-browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@microsoft/microsoft-graph-client/lib/graph-js-sdk-web.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const msalConfig = {
        auth: {
          clientId: '8e23d112-104b-4e6a-a57d-7e3a2a61d837',
          authority: 'https://login.microsoftonline.com/20e27700-b670-4553-a27c-d8e2583b3289',
          redirectUri: 'https://work-qdc.github.io/Scheduling-Dashboard/'
        },
        cache: { cacheLocation: 'localStorage' }
      };

      const msalInstance = new msal.PublicClientApplication(msalConfig);

      async function signIn() {
        const accounts = msalInstance.getAllAccounts();
        if (!accounts.length) {
          await msalInstance.loginPopup({ scopes: ['User.Read', 'Sites.Read.All', 'Sites.ReadWrite.All'] });
        }
      }

      async function getToken(scopes) {
        try {
          return (await msalInstance.acquireTokenSilent({ scopes })).accessToken;
        } catch {
          return (await msalInstance.acquireTokenPopup({ scopes })).accessToken;
        }
      }

      function client(token) {
        return MicrosoftGraph.Client.init({ authProvider: done => done(null, token) });
      }

      let EMP_LIST_ID, SCHED_LIST_ID;

      async function getSiteId(g) {
        const site = await g.api(`/sites/tcco.sharepoint.com:/sites/SchedulingToolTest:/`).get();
        return site.id;
      }

      async function initLists() {
        await signIn();
        const token = await getToken(['Sites.Read.All']);
        const g = client(token);
        const sid = await getSiteId(g);
        const res = await g.api(`/sites/${sid}/lists`).get();
        EMP_LIST_ID = res.value.find(l => l.displayName === 'SchedulingEmployeeTest').id;
        SCHED_LIST_ID = res.value.find(l => l.displayName === 'TestTableScheduling').id;
      }

      async function fetchEmployees() {
        const token = await getToken(['Sites.Read.All']);
        const g = client(token);
        const sid = await getSiteId(g);
        const r = await g.api(`/sites/${sid}/lists/${EMP_LIST_ID}/items`).expand('fields').get();
        window.employees = r.value.map(i => ({ id: i.id, name: i.fields.Title, email: i.fields.Employeesemail }));
        populateEmployeeSelects();
        renderEmployeeTable();
      }

      async function fetchEntries() {
        const token = await getToken(['Sites.Read.All']);
        const g = client(token);
        const sid = await getSiteId(g);
        const r = await g.api(`/sites/${sid}/lists/${SCHED_LIST_ID}/items`).expand('fields').get();
        window.entries = r.value.map(i => ({
          id: i.id, title: i.fields.Title, topic: i.fields.Topic, status: i.fields.RegistrationStatus,
          start: i.fields.StartDate, end: i.fields.EndDate, location: i.fields.Location,
          link: i.fields.Link, industry: i.fields.Industry, desc: i.fields.Description,
          applicationdeadline: i.fields.ApplicationDeadline, internalExternal: i.fields.Internal_x002f_External, AssignedEmployee: i.fields.AssignedEmployee,
  notes: i.fields.Notes
        }));
        renderList();
      }

      async function addEmployee() {
        const name = prompt('Enter employee name:');
        const email = prompt('Enter employee email:');
        if (!name || !email) return;
        const token = await getToken(['Sites.ReadWrite.All']);
        const g = client(token);
        const sid = await getSiteId(g);
        await g.api(`/sites/${sid}/lists/${EMP_LIST_ID}/items`).post({ fields: { Title: name, Employeesemail: email } });
        await fetchEmployees();
      }

      async function addEntry() {
  try {
    const token = await getToken(['Sites.ReadWrite.All']);
    const g = client(token);
    const sid = await getSiteId(g);

    // üü¢ Correct place to declare name/email
    const sel = document.getElementById('new-AssignedEmployee');
    const selectedOption = sel.options[sel.selectedIndex];
    const assignedEmployeeName = selectedOption.value;
    const assignedEmployeeEmail = (window.employees.find(e => e.name === assignedEmployeeName) || {}).email;

    const fields = {
      Title:                     document.getElementById('new-title').value,
      Topic:                     document.getElementById('new-topic').value,
      RegistrationStatus:        document.getElementById('new-status').value,
      TypeofEngagement:          document.getElementById('new-type').value,
      StartDate:                 document.getElementById('new-start').value,
      EndDate:                   document.getElementById('new-end').value,
      Location:                  document.getElementById('new-location').value,
      Link:                      document.getElementById('new-link').value,
      Industry:                  document.getElementById('new-industry').value,
      Description:               document.getElementById('new-desc').value,
      ApplicationDeadline:       document.getElementById('new-applicationdeadline').value,
      Internal_x002f_External:   document.getElementById('new-internal/external').value,
      AssignedEmployee:          assignedEmployeeName,  // ‚úÖ Name saved
      Notes:                     document.getElementById('new-notes').value
    };

    await g.api(`/sites/${sid}/lists/${SCHED_LIST_ID}/items`).post({ fields });

// ‚úÖ Send calendar invite
if (assignedEmployeeEmail && assignedEmployeeEmail.includes('@')) {
  const event = {
    subject: fields.Title || 'Scheduled Event',
    body: {
      contentType: 'Text',
      content: fields.Description || 'Scheduled event via scheduling tool.'
    },
    start: {
      dateTime: `${fields.StartDate}T09:00:00`,
      timeZone: 'UTC'
    },
    end: {
      dateTime: `${fields.EndDate}T17:00:00`,
      timeZone: 'UTC'
    },
    location: {
      displayName: fields.Location || 'TBD'
    },
    attendees: [
      {
        emailAddress: {
          address: assignedEmployeeEmail,
          name: assignedEmployeeName
        },
        type: 'required'
      }
    ],
    responseRequested: true,
    isOnlineMeeting: false
  };

  try {
    await g.api('/me/events')
      .query({ sendInvitations: true })
      .post(event);
    console.log('‚úÖ Calendar invite sent to:', assignedEmployeeEmail);
  } catch (inviteErr) {
    console.error('‚ùå Failed to send calendar invite:', inviteErr);
    alert(`Event created, but failed to send invite:\n${inviteErr.message}`);
  }
}

    await fetchEntries();
  } catch (err) {
    console.error('addEntry failed:', err);
    alert(`Error adding entry:\n${err.message}`);
  }
}
      function populateEmployeeSelects() {
  const sel = document.getElementById('new-AssignedEmployee');
  const filterSel = document.getElementById('employee-filter');
  const calSel = document.getElementById('calendar-employee-filter');

  sel.innerHTML = '<option value="">--Select--</option>';
  filterSel.innerHTML = '<option value="">All</option>';
  calSel.innerHTML = '<option value="">All</option>';

  window.employees.forEach(e => {
    const o1 = document.createElement('option');
    o1.value = e.name;
    o1.textContent = e.name;
    sel.appendChild(o1);

    const o2 = o1.cloneNode(true);
    filterSel.appendChild(o2);

    const o3 = o1.cloneNode(true);
    calSel.appendChild(o3);
  });
}
      function renderEmployeeTable() {
        const body = document.getElementById('employee-table-body');
        body.innerHTML = '';
        window.employees.forEach(e => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${e.name}</td><td>${e.email}</td><td><button class="btn btn-sm btn-outline-danger" data-id="${e.id}">Delete</button></td>`;
          tr.querySelector('button').addEventListener('click', async () => {
            const token = await getToken(['Sites.ReadWrite.All']);
            const g = client(token);
            const sid = await getSiteId(g);
            await g.api(`/sites/${sid}/lists/${EMP_LIST_ID}/items/${e.id}`).delete();
            await fetchEmployees();
          });
          body.appendChild(tr);
        });
      }
function renderCalendarView() {
  function renderCalendarView() {
  const container = document.getElementById('calendar-table-wrapper');
  container.innerHTML = ''; // Clear previous content

  const calendarEl = document.createElement('div');
  container.appendChild(calendarEl);

  const selectedEmployee = document.getElementById('calendar-employee-filter').value;

  const filteredEvents = window.entries
    .filter(e => !selectedEmployee || e.AssignedEmployee === selectedEmployee)
    .map(e => ({
      id: e.id,
      title: e.title || '(No Title)',
      start: e.start,
      end: e.end,
      extendedProps: {
        location: e.location,
        notes: e.notes
      }
    }));

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    height: 'auto',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,listWeek'
    },
    events: filteredEvents,
    eventClick: function(info) {
      const { title, start, end, extendedProps } = info.event;
      alert(
        `Event: ${title}\nStart: ${start.toLocaleString()}\nEnd: ${end?.toLocaleString() || 'N/A'}\nLocation: ${extendedProps.location || 'N/A'}\nNotes: ${extendedProps.notes || 'None'}`
      );
    }
  });

  calendar.render();
}
      function renderList() {
  const tbody = document.getElementById('entries-tbody');
  tbody.innerHTML = '';
  window.entries.forEach(e => {
    const dn = e.AssignedEmployee || '(Unassigned)';
    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td></td>
      <td>${e.title}</td>
      <td>${e.topic}</td>
      <td>${e.status}</td>
      <td>${e.start}</td>
      <td>${e.end}</td>
      <td>${e.location}</td>
      <td><a href="${e.link}" target="_blank">link</a></td>
      <td>${e.industry}</td>
      <td>${e.desc}</td>
      <td>${e.applicationdeadline}</td>
      <td>${e.internalExternal}</td>
      <td>${dn}</td>
      <td>${e.notes}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary me-1 edit-entry" data-id="${e.id}">Edit</button>
        <button class="btn btn-sm btn-outline-danger del-entry" data-id="${e.id}">Delete</button>
      </td>
    `;

    // Delete logic (unchanged)
    tr.querySelector('.del-entry').addEventListener('click', async () => {
      const token = await getToken(['Sites.ReadWrite.All']);
      const g = client(token);
      const sid = await getSiteId(g);
      await g.api(`/sites/${sid}/lists/${SCHED_LIST_ID}/items/${e.id}`).delete();
      await fetchEntries();
    });

    // Edit logic
    tr.querySelector('.edit-entry').addEventListener('click', () => {
      enableEditMode(tr, e);
    });

        tbody.appendChild(tr);
  });
  applyEmployeeFilter(); // <-- This applies the filter after rendering
}

function applyEmployeeFilter() {
  const selected = document.getElementById('employee-filter').value;
  const rows = document.querySelectorAll('#entries-tbody tr');
  rows.forEach(row => {
    const cellText = row.children[12]?.textContent || '';
    row.style.display = (!selected || cellText === selected) ? '' : 'none';
  });
}

      function formatDateOnly(isoString) {
  if (!isoString || typeof isoString !== 'string') return '';
  return isoString.split('T')[0];
}
function enableEditMode(row, entry) {
  const fields = [
    'title', 'topic', 'status', 'start', 'end',
    'location', 'link', 'industry', 'desc',
    'applicationdeadline', 'deliver', 'internal/external', 'AssignedEmployee', 'notes'
  ];

  const td = row.querySelectorAll('td');
  td[1].innerHTML = `<input class="form-control form-control-sm" value="${entry.title || ''}" />`;
  td[2].innerHTML = `<input class="form-control form-control-sm" value="${entry.topic || ''}" />`;
  td[3].innerHTML = `<input class="form-control form-control-sm" value="${entry.status || ''}" />`;
  td[4].innerHTML = `<input type="date" class="form-control form-control-sm" value="${formatDateOnly(entry.start)}" />`;
  td[5].innerHTML = `<input type="date" class="form-control form-control-sm" value="${formatDateOnly(entry.end)}" />`;
  td[6].innerHTML = `<input class="form-control form-control-sm" value="${entry.location || ''}" />`;
  td[7].innerHTML = `<input class="form-control form-control-sm" value="${entry.link || ''}" />`;
  td[8].innerHTML = `<input class="form-control form-control-sm" value="${entry.industry || ''}" />`;
  td[9].innerHTML = `<textarea class="form-control form-control-sm">${entry.desc || ''}</textarea>`;
  td[10].innerHTML = `<input type="date" class="form-control form-control-sm" value="${formatDateOnly(entry.applicationdeadline)}" />`;
  td[11].innerHTML = `<select class="form-select form-select-sm">
  <option>Internal</option><option>External</option>
</select>`;
  td[11].querySelector('select').value = entry.internalExternal || 'Internal';
td[12].innerHTML = `<select class="form-select form-select-sm">
  ${window.employees.map(e => 
    `<option value="${e.name}" ${e.name === entry.AssignedEmployee ? 'selected' : ''}>
      ${e.name}
    </option>`
  ).join('')}
</select>`;
td[13].innerHTML = `<textarea class="form-control form-control-sm">${entry.notes || ''}</textarea>`;
  td[14].innerHTML = `
    <button class="btn btn-sm btn-success me-1 save-edit">Save</button>
    <button class="btn btn-sm btn-secondary cancel-edit">Cancel</button>`;
  td[14].querySelector('.save-edit').addEventListener('click', async () => {
  const updated = {};
  const set = (key, val) => {
    if (val !== '') updated[key] = val;
  };

  set('Title', td[1].querySelector('input').value);
  set('Topic', td[2].querySelector('input').value);
  set('RegistrationStatus', td[3].querySelector('input').value);
  set('StartDate', td[4].querySelector('input').value);
  set('EndDate', td[5].querySelector('input').value);
  set('Location', td[6].querySelector('input').value);
  set('Link', td[7].querySelector('input').value);
  set('Industry', td[8].querySelector('input').value);
  set('Description', td[9].querySelector('textarea').value);
  set('ApplicationDeadline', td[10].querySelector('input').value);
  set('Internal_x002f_External', td[11].querySelector('select').value);
set('AssignedEmployee',        td[12].querySelector('select').value);
set('Notes',                   td[13].querySelector('textarea').value);


  try {
    const token = await getToken(['Sites.ReadWrite.All']);
    const g = client(token);
    const sid = await getSiteId(g);

    console.log('PATCH payload:', updated);

    await g.api(`/sites/${sid}/lists/${SCHED_LIST_ID}/items/${entry.id}/fields`)
      .patch(updated);
    // ‚úÖ Send calendar invite when an employee is assigned
const assignedName = td[12].querySelector('select').value;
const assignedEmail = (window.employees.find(e => e.name === assignedName) || {}).email;

if (assignedEmail && assignedEmail.includes('@')) {
  const event = {
    subject: updated.Title || 'Scheduled Event',
    body: {
      contentType: 'Text',
      content: updated.Description || 'Scheduled event via scheduling tool.'
    },
    start: {
      dateTime: `${updated.StartDate || entry.start}T09:00:00`,
      timeZone: 'UTC'
    },
    end: {
      dateTime: `${updated.EndDate || entry.end}T17:00:00`,
      timeZone: 'UTC'
    },
    location: {
      displayName: updated.Location || 'TBD'
    },
    attendees: [
      {
        emailAddress: {
          address: assignedEmail,
          name: assignedName
        },
        type: 'required'
      }
    ],
    responseRequested: true,
    isOnlineMeeting: false
  };

  try {
    await g.api('/me/events')
      .query({ sendInvitations: true })
      .post(event);
    console.log('‚úÖ Calendar invite sent to:', assignedEmail);
  } catch (inviteErr) {
    console.error('‚ùå Failed to send calendar invite:', inviteErr);
    alert(`Event updated, but failed to send invite:\n${inviteErr.message}`);
  }
}

    await fetchEntries();
  } catch (err) {
    console.error('editEntry failed:', err);
    alert(`Failed to save edits:\n${err.message}`);
  }
});

  td[14].querySelector('.cancel-edit').addEventListener('click', () => {
    renderList(); // revert the table
  });
}
      document.getElementById('calendar-view-btn').addEventListener('click', () => {
  document.getElementById('calendar-container').style.display = 'block';
  document.getElementById('list-container').style.display = 'none';
  document.getElementById('calendar-view-btn').classList.add('d-none');
  document.getElementById('list-view-btn').classList.remove('d-none');

  renderCalendarView(); //
});

      document.getElementById('list-view-btn').addEventListener('click', () => {
        document.getElementById('calendar-container').style.display = 'none';
        document.getElementById('list-container').style.display = 'block';
        document.getElementById('calendar-view-btn').classList.remove('d-none');
        document.getElementById('list-view-btn').classList.add('d-none');
      });
      document.getElementById('calendar-list-view-btn').addEventListener('click', () =>
        document.getElementById('list-view-btn').click()
      );
      document.getElementById('edit-employees-btn').addEventListener('click', () =>
        new bootstrap.Modal(document.getElementById('employeeModal')).show()
      );
      document.getElementById('add-emp-btn').addEventListener('click', addEmployee);
      document.getElementById('add-entry-btn').addEventListener('click', addEntry);

      try {
  await initLists();
  await fetchEmployees();
  await fetchEntries();

  // üîÅ Add this line to bind the filter change event
  document.getElementById('employee-filter').addEventListener('change', applyEmployeeFilter);
        document.getElementById('calendar-employee-filter').addEventListener('change', renderCalendarView);
} catch (err) {
  console.error('Initialization error:', err);
  alert(`Initialization error:\n${err.message}`);
}
    });
  </script>
</body>
</html>
