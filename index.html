<!-- HEAD and HTML structure unchanged (same as before) -->
<!-- Here is the updated script section at the bottom of your index.html -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://alcdn.msauth.net/browser/2.27.0/js/msal-browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@microsoft/microsoft-graph-client/lib/graph-js-sdk-web.js"></script>
<script>
  const msalConfig = {
    auth: {
      clientId: '8e23d112-104b-4e6a-a57d-7e3a2a61d837',
      authority: 'https://login.microsoftonline.com/20e27700-b670-4553-a27c-d8e2583b3289',
      redirectUri: 'https://work-qdc.github.io/Scheduling-Dashboard/'
    },
    cache: { cacheLocation: 'localStorage' }
  };
  const msalInstance = new msal.PublicClientApplication(msalConfig);

  async function signIn() {
    const accounts = msalInstance.getAllAccounts();
    if (!accounts.length) {
      await msalInstance.loginPopup({
        scopes: ['User.Read', 'Sites.Read.All', 'Sites.ReadWrite.All']
      });
    }
  }

  let tokenLock = false;
  async function getToken(scopes) {
    if (tokenLock) throw new Error("Token acquisition already in progress.");
    tokenLock = true;
    try {
      return (await msalInstance.acquireTokenSilent({ scopes })).accessToken;
    } catch {
      return (await msalInstance.acquireTokenPopup({ scopes })).accessToken;
    } finally {
      tokenLock = false;
    }
  }

  function client(token) {
    return MicrosoftGraph.Client.init({ authProvider: done => done(null, token) });
  }

  async function getSiteId(g) {
    const site = await g.api(`/sites/tcco.sharepoint.com:/sites/SchedulingToolTest:/`).get();
    return site.id;
  }

  let EMP_LIST_ID, SCHED_LIST_ID;
  async function initLists() {
    await signIn();
    const token = await getToken(['Sites.Read.All']);
    const g = client(token);
    const sid = await getSiteId(g);
    const res = await g.api(`/sites/${sid}/lists`).get();
    const emp = res.value.find(l => l.displayName === 'SchedulingEmployeeTest');
    const sched = res.value.find(l => l.displayName === 'TestTableScheduling');
    if (!emp || !sched) throw new Error('âŒ Could not locate both SchedulingEmployeeTest and TestTableScheduling lists');
    EMP_LIST_ID = emp.id;
    SCHED_LIST_ID = sched.id;
  }

  async function fetchEmployees() {
    const token = await getToken(['Sites.Read.All']);
    const g = client(token);
    const sid = await getSiteId(g);
    const r = await g.api(`/sites/${sid}/lists/${EMP_LIST_ID}/items`).expand('fields').get();
    window.employees = r.value.map(i => ({ id: i.id, name: i.fields.Title, email: i.fields.Employeesemail }));
    populateEmployeeSelects();
    renderEmployeeTable();
  }

  async function fetchEntries() {
    const token = await getToken(['Sites.Read.All']);
    const g = client(token);
    const sid = await getSiteId(g);
    const r = await g.api(`/sites/${sid}/lists/${SCHED_LIST_ID}/items`).expand('fields').get();
    window.entries = r.value.map(i => ({
      id: i.id,
      title: i.fields.Title,
      topic: i.fields.Topic,
      status: i.fields.Status,
      start: i.fields.StartDate || i.fields.Start,
      end: i.fields.EndDate || i.fields.End,
      location: i.fields.Location,
      link: i.fields.Link,
      industry: i.fields.Industry,
      desc: i.fields.Description,
      deadline: i.fields.Deadline,
      deliver: i.fields.Deliverables,
      type: i.fields.Type,
      reco: i.fields.RecoEmp,
      assigned: i.fields.AssignedEmp,
      notes: i.fields.Notes
    }));
    renderList();
  }

  async function addEntry() {
    try {
      const token = await getToken(['Sites.ReadWrite.All']);
      const g = client(token);
      const sid = await getSiteId(g);

      const fields = {
        Title: document.getElementById('new-title').value,
        Topic: document.getElementById('new-topic').value,
        Status: document.getElementById('new-status').value,
        StartDate: document.getElementById('new-start').value,
        EndDate: document.getElementById('new-end').value,
        Location: document.getElementById('new-location').value,
        Link: document.getElementById('new-link').value,
        Industry: document.getElementById('new-industry').value,
        Description: document.getElementById('new-desc').value,
        Deadline: document.getElementById('new-deadline').value,
        Deliverables: document.getElementById('new-deliver').value,
        Type: document.getElementById('new-type').value,
        RecoEmp: document.getElementById('new-reco').value,
        AssignedEmp: document.getElementById('new-assigned').value,
        Notes: document.getElementById('new-notes').value
      };

      await g.api(`/sites/${sid}/lists/${SCHED_LIST_ID}/items`).post({ fields });
      await fetchEntries();
    } catch (err) {
      console.error('addEntry failed:', err);
      alert(`Error adding entry:\n${err.message}`);
    }
  }

  async function addEmployee() {
    try {
      const token = await getToken(['Sites.ReadWrite.All']);
      const g = client(token);
      const sid = await getSiteId(g);

      const name = prompt('Enter employee name:');
      const email = prompt('Enter employee email:');
      if (!name || !email) return;

      await g.api(`/sites/${sid}/lists/${EMP_LIST_ID}/items`)
        .post({ fields: { Title: name, Employeesemail: email } });

      await fetchEmployees();
    } catch (err) {
      console.error('addEmployee failed:', err);
      alert(`Error adding employee:\n${err.message}`);
    }
  }

  function populateEmployeeSelects() {
    const sel = document.getElementById('new-assigned');
    sel.innerHTML = '<option value="">--Select--</option>';
    window.employees.forEach(e => {
      const o = document.createElement('option');
      o.value = e.email;
      o.textContent = e.name;
      sel.appendChild(o);
    });
  }

  function renderEmployeeTable() {
    const body = document.getElementById('employee-table-body');
    body.innerHTML = '';
    window.employees.forEach(e => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${e.name}</td><td>${e.email}</td><td>
        <button type="button" class="btn btn-sm btn-outline-danger" data-id="${e.id}" data-action="del-emp">Delete</button>
      </td>`;
      tr.querySelector('[data-action="del-emp"]').addEventListener('click', async () => {
        const token = await getToken(['Sites.ReadWrite.All']);
        const g = client(token);
        const sid = await getSiteId(g);
        await g.api(`/sites/${sid}/lists/${EMP_LIST_ID}/items/${e.id}`).delete();
        await fetchEmployees();
      });
      body.appendChild(tr);
    });
  }

  function renderList() {
    const tbody = document.getElementById('entries-tbody');
    tbody.innerHTML = '';
    window.entries.forEach(e => {
      const emp = window.employees.find(x => x.email === e.assigned) || {};
      const dn = emp.name || e.assigned || '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td></td><td>${e.title}</td><td>${e.topic}</td><td>${e.status}</td><td>${e.start}</td><td>${e.end}</td>
        <td>${e.location}</td><td><a href="${e.link}" target="_blank">link</a></td><td>${e.industry}</td><td>${e.desc}</td>
        <td>${e.deadline}</td><td>${e.deliver}</td><td>${e.type}</td><td>${e.reco}</td><td>${dn}</td><td>${e.notes}</td>
        <td><button class="btn btn-sm btn-outline-danger del-entry" data-id="${e.id}">Delete</button></td>
      `;
      tr.querySelector('.del-entry').addEventListener('click', async () => {
        const token = await getToken(['Sites.ReadWrite.All']);
        const g = client(token);
        const sid = await getSiteId(g);
        await g.api(`/sites/${sid}/lists/${SCHED_LIST_ID}/items/${e.id}`).delete();
        await fetchEntries();
      });
      tbody.appendChild(tr);
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('calendar-view-btn').addEventListener('click', () => {
      document.getElementById('calendar-container').style.display = 'block';
      document.getElementById('list-container').style.display = 'none';
      document.getElementById('calendar-view-btn').classList.add('d-none');
      document.getElementById('list-view-btn').classList.remove('d-none');
    });
    document.getElementById('list-view-btn').addEventListener('click', () => {
      document.getElementById('calendar-container').style.display = 'none';
      document.getElementById('list-container').style.display = 'block';
      document.getElementById('calendar-view-btn').classList.remove('d-none');
      document.getElementById('list-view-btn').classList.add('d-none');
    });
    document.getElementById('calendar-list-view-btn').addEventListener('click', () =>
      document.getElementById('list-view-btn').click()
    );
    document.getElementById('edit-employees-btn').addEventListener('click', () =>
      new bootstrap.Modal(document.getElementById('employeeModal')).show()
    );
    document.getElementById('add-emp-btn').addEventListener('click', addEmployee);
    document.getElementById('add-entry-btn').addEventListener('click', addEntry);

    (async () => {
      try {
        await initLists();
        await fetchEmployees();
        await fetchEntries();
      } catch (err) {
        console.error('Initialization error:', err);
        alert(`Initialization error:\n${err.message}`);
      }
    })();
  });
</script>
